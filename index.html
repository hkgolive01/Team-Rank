<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Team Rank</title>
    <style>
        :root {
            --primary-dark: #2c3e50;
            --primary-blue: #2980b9;
            --gold-bg: #fffbf0;
            --gold-bar: #f1c40f;
            --gold-text: #9a7605;
            --silver-bg: #f8f9fa;
            --silver-bar: #bdc3c7;
            --silver-text: #666;
            --bronze-bg: #fff5eb;
            --bronze-bar: #d35400;
            --bronze-text: #a84300;

            --header-height: 0mm;
            --footer-height: 15mm;
            --a4-side-margin: 4mm;

            --header-row: calc(var(--header-height) / 2);
        }

        * { box-sizing: border-box; }

        html, body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
            background: #444;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .left-panel {
            width: 40%;
            background: #fdfdfd;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 4px 0 10px rgba(0,0,0,0.08);
            z-index: 20;
        }

        .panel-title { font-size: 18px; font-weight: bold; color: var(--primary-dark); margin-bottom: 12px; border-bottom: none; padding-bottom: 6px; }
        .config-box { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; }
        .form-row { display:flex; align-items:center; margin-bottom:8px; }
        .form-row label { width:90px; color:#555; font-weight:600; }
        .form-row input[type="number"] { width:60px; padding:4px; text-align:center; border:1px solid #ccc; border-radius:4px; }
        .form-row select { padding:4px; border-radius:4px; border:1px solid #ccc; }

        .input-area { flex:1; display:grid; grid-template-columns:1fr 1fr; grid-auto-rows:200px; gap:10px; padding-bottom:20px; align-content:start; }
        textarea.data-frame { width:100%; height:100%; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:12px; resize:none; font-family:monospace; background:#fff; line-height:1.4; }
        textarea.data-frame:focus { border-color:var(--primary-blue); background:#fafdff; outline:none; }

        .input-frame { display:flex; flex-direction:column; gap:6px; }
        .frame-controls { display:flex; align-items:center; gap:6px; justify-content:space-between; }
        .frame-controls .left { display:flex; align-items:center; gap:8px; }
        .layer-badge { display:inline-block; background:#f0f2f5; border:1px solid #ddd; padding:2px 6px; border-radius:4px; font-size:12px; color:#333; min-width:40px; text-align:center; }
        .group-name { color:#c0392b; font-weight:700; font-size:12px; margin-left:6px; white-space:nowrap; max-width:160px; overflow:hidden; text-overflow:ellipsis; }
        .frame-btn { background:#fff; border:1px solid #ccc; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px; }
        .frame-btn.small { padding:2px 6px; font-size:11px; }
        .clear-all-btn { background:#fff; border:1px solid #e57373; color:#c0392b; padding:6px 10px; border-radius:4px; cursor:pointer; font-weight:700; font-size:13px; }

        .right-panel {
            width: 60%;
            background: #525659;
            padding: 18px;
            overflow-y: auto;
            display: block;
            text-align: center;
        }

        .preview-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 10px;
        }

        .print-btn {
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        .print-btn:active { transform: translateY(1px); }

        .a4-sheet {
            width: min(210mm, calc(100% - 40px));
            min-height: 297mm;
            background: white;
            margin: 0 auto 30px auto;
            padding: calc(var(--header-height) + 8mm) var(--a4-side-margin) calc(var(--footer-height) + 8mm) var(--a4-side-margin);
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            position: relative;
            text-align: left;
            overflow: visible;
        }

        table.result-table { width:100%; border-collapse:collapse; font-size:13px; margin-bottom:10px; table-layout:fixed; word-break:break-word; background:white; }
        table.result-table thead { display: table-header-group; }
        table.result-table tfoot { display: table-footer-group; } 

        table.result-table thead tr.title-row th {
            padding-top: calc(var(--header-row) * 0.6);
            padding-bottom: calc(var(--header-row) * 0.4);
            vertical-align: middle;
            text-align: center;
            font-weight: 900;
            font-size: 26px;
            color: var(--primary-dark);
            background: transparent;
        }
        table.result-table thead tr.date-row th {
            padding-top: calc(var(--header-row) * 0.3);
            padding-bottom: calc(var(--header-row) * 0.7);
            vertical-align: middle;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            background: transparent;
        }
        table.result-table thead tr.colhead-row th {
            padding:6px 4px;
            text-align:center;
            font-weight:700;
            font-size:13px;
            color: var(--primary-dark);
            border-bottom:none;
            background: #f1ee09e2;
        }

        table.result-table tfoot tr td {
            padding:6px 8px;
            text-align:center;
            font-size:11px;
            color:#555;
            border-top:1px solid #ddd;
            background:#fff;
        }

        table.result-table td { padding:6px 4px; border-bottom:none; vertical-align:middle; color:#333; background: #fff; }

        tr.detail-row td { padding:0 8px 12px 8px; border-bottom:none; background-color:inherit; }
        .school-body { display:block; page-break-inside:avoid; break-inside:avoid; -webkit-column-break-inside:avoid; padding-top:6px; padding-bottom:6px; }

        td.rank-cell { position:relative; padding:0; text-align:center; height:1px; }
        .rank-content-wrapper { width:100%; height:100%; display:flex; align-items:center; justify-content:center; min-height:35px; }
        .rank-num { font-size:18px; font-weight:bold; z-index:2; position:relative; }
        .color-bar { position:absolute; left:0; top:0; bottom:0; width:5px; display:none; }

        tr.rank-1, tr.rank-1+.detail-row { background-color:var(--gold-bg); }
        tr.rank-1 .color-bar { display:block; background:var(--gold-bar); }
        tr.rank-1 .rank-num { color:var(--gold-text); font-size:24px; text-shadow:0 1px 0 rgba(255,255,255,0.8); }
        tr.rank-1 .school-name { color:var(--gold-text); font-size:18px; }

        tr.rank-2, tr.rank-2+.detail-row { background-color:var(--silver-bg); }
        tr.rank-2 .color-bar { display:block; background:var(--silver-bar); }
        tr.rank-2 .rank-num { color:var(--silver-text); font-size:20px; }
        tr.rank-2 .school-name { color:var(--silver-text); font-size:16px; }

        tr.rank-3, tr.rank-3+.detail-row { background-color:var(--bronze-bg); }
        tr.rank-3 .color-bar { display:block; background:var(--bronze-bar); }
        tr.rank-3 .rank-num { color:var(--bronze-text); font-size:20px; }
        tr.rank-3 .school-name { color:var(--bronze-text); font-size:16px; }

        .school-name { font-weight:800; font-size:15px; margin-bottom:2px; padding-left:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .ineligible-text { color:#c0392b; font-size:10px; font-weight:bold; padding-left:5px; }
        .ineligible-row, .ineligible-row+.detail-row { opacity:0.6; background:#fafafa; }
        .total-score { font-size:16px; font-weight:800; color:#333; text-align:center; }
        .score-val { font-size:12px; color:#555; text-align:center; }

        .student-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:5px; width:100%; margin-top:4px; }
        .student-cell { background:rgba(255,255,255,0.85); border:1px solid rgba(0,0,0,0.06); border-radius:4px; padding:3px 5px; display:flex; flex-direction:column; justify-content:center; min-height:38px; }
        .st-name { font-size:11px; font-weight:bold; color:#222; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; }
        .st-info-row { display:flex; align-items:center; justify-content:space-between; font-size:10px; width:100%; line-height:1.2; }
        .st-left-group { display:flex; align-items:center; overflow:hidden; white-space:nowrap; }
        .st-cat { color:#666; margin-right:3px; max-width:50px; overflow:hidden; text-overflow:ellipsis; }
        .st-rank { color:#333; font-weight:800; }
        .score-badge { padding:0px 3px; border-radius:3px; font-weight:bold; font-size:9px; min-width:16px; text-align:center; flex-shrink:0; }
        .badge-gold { background-color:#ffe082; color:#6f4e00; border:1px solid #ffd54f; }
        .badge-silver { background-color:#e0e0e0; color:#424242; border:1px solid #bdbdbd; }
        .badge-bronze { background-color:#ffccbc; color:#bf360c; border:1px solid #ffab91; }
        .badge-normal { background-color:#e3f2fd; color:#1565c0; border:1px solid #90caf9; }
        .dimmed { opacity:0.5; }
        .dimmed .score-badge { visibility:hidden; }

        @media print {
            @page { size:A4; margin:5mm; }

            html, body { background:white; height:auto !important; display:block; overflow:visible !important; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }

            .left-panel, .preview-actions, .print-btn { display: none !important; }

            .right-panel { width:100%; display:block; padding:0; margin:0; background:white; overflow:visible !important; }

            .a4-sheet {
                width: 100% !important;
                margin: 0;
                box-shadow: none !important;
                min-height: auto !important;
                padding: 4mm var(--a4-side-margin) 4mm var(--a4-side-margin) !important;
                overflow: visible !important;
                page-break-after: always;
            }

            table.result-table thead tr.title-row th,
            table.result-table thead tr.date-row th {
                padding-top: calc(var(--header-row) * 0.6) !important;
                padding-bottom: calc(var(--header-row) * 0.4) !important;
                vertical-align: middle !important;
                text-align: center !important;
                font-weight: 700 !important;
                color: var(--primary-dark) !important;
                background: transparent !important;
            }

            tbody.school-block { page-break-inside: avoid; break-inside: avoid; -webkit-column-break-inside: avoid; -moz-column-break-inside: avoid; }
            .school-body { page-break-inside: avoid; break-inside: avoid; -webkit-column-break-inside: avoid; -moz-column-break-inside: avoid; }

            tbody.page-break-before { display: table-row-group !important; page-break-before: always !important; break-before: page !important; -webkit-column-break-before: always !important; -moz-column-break-before: always !important; }

            tr.ineligible-row, tr.ineligible-row+.detail-row { display: none !important; }
        }

        @media (max-width: 900px) {
            .left-panel { width: 100%; height: 40vh; overflow-y:auto; }
            .right-panel { width: 100%; padding: 12px; }
            .input-area { grid-template-columns: 1fr; grid-auto-rows: 160px; }
            .a4-sheet { width: 100%; min-height: auto; padding: 12mm; box-shadow: none; margin-bottom: 16px; }
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="panel-title">團體獎設定</div>

        <div class="config-box">
            <div style="font-weight:bold;margin-bottom:5px;">門檻與權重</div>
            <div class="form-row">
                <label>最少人數：</label>
                <input type="number" id="cfg_threshold" value="3" onchange="recalc()" />
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                <div class="form-row" style="width:48%"><label style="width:50px">冠軍</label><input type="number" id="p1" value="20" onchange="recalc()" /></div>
                <div class="form-row" style="width:48%"><label style="width:50px">亞軍</label><input type="number" id="p2" value="13" onchange="recalc()" /></div>
                <div class="form-row" style="width:48%"><label style="width:50px">季軍</label><input type="number" id="p3" value="8" onchange="recalc()" /></div>
                <div class="form-row" style="width:48%"><label style="width:50px">4-8名</label><input type="number" id="p4" value="5" onchange="recalc()" /></div>
            </div>
        </div>

        <div class="config-box">
            <div style="font-weight:bold;margin-bottom:5px;">計算模式</div>
            <div class="form-row">
                <select id="cfg_mode" onchange="toggleMode()" style="width:100%">
                    <option value="all">全校總分 (參與分 = 總人數)</option>
                    <option value="topX">只算前 X 名 (參與分可選)</option>
                </select>
            </div>
            <div id="topX_opts" style="display:none; padding-left:5px; margin-top:5px; font-size:12px;">
                <div class="form-row">
                    <label style="width:70px">取前幾名</label>
                    <input type="number" id="cfg_topX" value="3" onchange="recalc()" />
                </div>
                <div style="margin-top:4px">
                    <input type="checkbox" id="cfg_inc_part" checked onchange="recalc()" />
                    <label for="cfg_inc_part" style="width:auto; display:inline;">Top X 模式下仍加總參與分</label>
                </div>
            </div>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <div class="panel-title" style="font-size:14px; border:none; margin:0;">貼上成績資料</div>
            <div class="input-actions">
                <button class="clear-all-btn" onclick="clearAllFrames()">一鍵清空</button>
            </div>
        </div>

        <div class="input-area" id="inputContainer"></div>
    </div>

    <div class="right-panel">
        <div class="preview-actions">
            <button class="print-btn" onclick="window.print()" title="列印">列印</button>
        </div>

        <div class="a4-sheet" id="sheet">
            <table class="result-table" id="resultTable" aria-label="團體獎排名">
                <colgroup>
                    <col style="width: 5%" />
                    <col style="width: 40%" />
                    <col style="width: 20%" />
                    <col style="width: 15%" />
                    <col style="width: 20%" />
                </colgroup>

                <thead>
                    <tr class="title-row">
                        <th id="theadTitle" colspan="5">學校團體獎公佈表</th>
                    </tr>
                    <tr class="date-row">
                        <th id="theadDate" colspan="5">日期：--</th>
                    </tr>
                    <tr class="colhead-row">
                        <th width="5%">排名</th>
                        <th width="40%">學校</th>
                        <th width="20%">總分</th>
                        <th width="15%">名次分</th>
                        <th width="20%">參與分</th>
                    </tr>
                </thead>

                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center; padding:50px; color:#bbb;">(等待輸入)</td></tr>
                </tbody>

                <tfoot>
                    <tr><td colspan="5" id="tfootRules">規則載入中...</td></tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const container = document.getElementById('inputContainer');
        const STORAGE_KEY = 'teamrank_frames_v1';

        function makeFrameElement(content = '', layerIndex = null) {
            const wrap = document.createElement('div');
            wrap.className = 'input-frame';

            const controls = document.createElement('div');
            controls.className = 'frame-controls';

            const left = document.createElement('div');
            left.className = 'left';

            const layerBadge = document.createElement('div');
            layerBadge.className = 'layer-badge';
            layerBadge.innerText = layerIndex !== null ? `第 ${layerIndex} 層` : '第 - 層';

            const groupName = document.createElement('div');
            groupName.className = 'group-name';
            groupName.innerText = '';

            const upBtn = document.createElement('button');
            upBtn.className = 'frame-btn small';
            upBtn.innerText = '↑';
            upBtn.title = '上移層級';
            upBtn.onclick = () => { moveFrame(wrap, -1); };

            const downBtn = document.createElement('button');
            downBtn.className = 'frame-btn small';
            downBtn.innerText = '↓';
            downBtn.title = '下移層級';
            downBtn.onclick = () => { moveFrame(wrap, 1); };

            left.appendChild(layerBadge);
            left.appendChild(groupName);
            left.appendChild(upBtn);
            left.appendChild(downBtn);

            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.gap = '6px';
            right.style.alignItems = 'center';

            const clearBtn = document.createElement('button');
            clearBtn.className = 'frame-btn';
            clearBtn.innerText = '清空';
            clearBtn.title = '清除本層內容';
            clearBtn.onclick = () => {
                const ta = wrap.querySelector('textarea');
                ta.value = '';
                ta.dispatchEvent(new Event('input'));
            };

            right.appendChild(clearBtn);

            controls.appendChild(left);
            controls.appendChild(right);

            const ta = document.createElement('textarea');
            ta.className = 'data-frame';
            ta.value = content || '';
            ta.placeholder = "請貼上成績...\n第1行：【比賽名稱】(標題)\n第2行：組別\n第3行：日期\n第4行起：姓名 學校";
            ta.addEventListener('input', onFrameInput);

            wrap.appendChild(controls);
            wrap.appendChild(ta);

            wrap._layerBadge = layerBadge;
            wrap._groupName = groupName;
            wrap._textarea = ta;

            return wrap;
        }

        function addInputFrame(content = '', insertAt = null, preventSave = false) {
            const frames = container.querySelectorAll('.input-frame');
            const el = makeFrameElement(content, frames.length + 1);
            if (insertAt !== null && insertAt <= frames.length - 1) {
                container.insertBefore(el, frames[insertAt]);
            } else {
                container.appendChild(el);
            }
            refreshLayerLabels();
            if (!preventSave) ensureTrailingEmptyFrame();
            if (!preventSave) saveFramesToStorage();
            recalc();
        }

        function ensureTrailingEmptyFrame() {
            const frames = container.querySelectorAll('.input-frame');
            if (frames.length === 0) {
                addInputFrame('', null, false);
                return;
            }
            const last = frames[frames.length - 1];
            const ta = last.querySelector('textarea');
            if (ta.value.trim().length > 0) addInputFrame('', null, false);
        }

        function onFrameInput(e) {
            refreshLayerLabels();
            ensureTrailingEmptyFrame();
            saveFramesToStorage();
            recalc();
        }

        function refreshLayerLabels() {
            const frames = container.querySelectorAll('.input-frame');
            frames.forEach((f, i) => {
                if (f._layerBadge) f._layerBadge.innerText = `第 ${i + 1} 層`;
                try {
                    const txt = f._textarea.value || '';
                    const lines = txt.split('\n').map(l => l.trim()).filter(l => l !== '');
                    const group = lines[1] || '';
                    if (f._groupName) {
                        f._groupName.innerText = group ? `${group}` : '';
                    }
                } catch (err) {
                    if (f._groupName) f._groupName.innerText = '';
                }
            });
        }

        function moveFrame(frameEl, dir) {
            const frames = Array.from(container.querySelectorAll('.input-frame'));
            const idx = frames.indexOf(frameEl);
            if (idx === -1) return;
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= frames.length) return;
            if (dir === -1) container.insertBefore(frameEl, frames[newIdx]);
            else container.insertBefore(frames[newIdx], frameEl);
            refreshLayerLabels();
            saveFramesToStorage();
            recalc();
        }

        function clearAllFrames() {
            if (!confirm('確定要清空所有貼上框內容並移除儲存？')) return;
            localStorage.removeItem(STORAGE_KEY);
            container.innerHTML = '';
            addInputFrame('', null, false);
            saveFramesToStorage();
            recalc();
        }

        function saveFramesToStorage() {
            const frames = Array.from(container.querySelectorAll('.input-frame'));
            const data = frames.map(f => f._textarea.value || '');
            while (data.length > 0 && data[data.length - 1].trim() === '') data.pop();
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error('儲存失敗', e); }
        }

        function loadFramesFromStorage() {
            const raw = localStorage.getItem(STORAGE_KEY);
            container.innerHTML = '';
            if (!raw) { addInputFrame('', null, false); saveFramesToStorage(); return; }
            try {
                const arr = JSON.parse(raw);
                if (!Array.isArray(arr) || arr.length === 0) { addInputFrame('', null, false); saveFramesToStorage(); return; }
                while (arr.length > 0 && (arr[arr.length - 1] === null || arr[arr.length - 1].toString().trim() === '')) arr.pop();
                arr.forEach(c => addInputFrame(c, null, true));
                ensureTrailingEmptyFrame();
                saveFramesToStorage();
            } catch (e) {
                console.error('載入儲存失敗', e);
                addInputFrame('', null, false);
                saveFramesToStorage();
            }
        }

        function toggleMode() {
            const mode = document.getElementById('cfg_mode').value;
            document.getElementById('topX_opts').style.display = (mode === 'topX') ? 'block' : 'none';
            recalc();
        }

        window.onload = () => { loadFramesFromStorage(); recalc(); };

        function recalc() {
            const threshold = parseInt(document.getElementById('cfg_threshold').value) || 3;
            const mode = document.getElementById('cfg_mode').value;
            const topX = parseInt(document.getElementById('cfg_topX').value) || 3;
            const incPart = document.getElementById('cfg_inc_part') ? document.getElementById('cfg_inc_part').checked : true;

            const pts = {
                1: parseInt(document.getElementById('p1').value) || 0,
                2: parseInt(document.getElementById('p2').value) || 0,
                3: parseInt(document.getElementById('p3').value) || 0,
                4: parseInt(document.getElementById('p4').value) || 0
            };

            let rules = `【計分方式】 冠軍 ${pts[1]}分 / 亞軍 ${pts[2]}分 / 季軍 ${pts[3]}分 / 4-8名 ${pts[4]}分。 `;
            rules += `需滿 ${threshold} 人。`;
            if (mode === 'all') rules += ` (總分 = 所有名次分 + 參與人數)`;
            else rules += ` (總分 = 前${topX}名成績 + ${incPart ? '參與人數' : '0'})`;

            const tfootRuleEl = document.getElementById('tfootRules');
            if (tfootRuleEl) tfootRuleEl.innerText = rules;

            const frames = Array.from(container.querySelectorAll('.input-frame'));
            const categoryPriority = {};
            frames.forEach((f, idx) => {
                const t = f._textarea.value.trim();
                if (!t) return;
                const lines = t.split('\n').map(l => l.trim()).filter(l => l !== '');
                if (lines.length < 2) return;
                const cat = lines[1];
                if (cat && !(cat in categoryPriority)) categoryPriority[cat] = idx + 1;
            });

            const schools = {};
            let globalTitle = "";
            let uniqueDates = new Set();

            frames.forEach(f => {
                const txt = f._textarea.value.trim();
                if (!txt) return;
                const lines = txt.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 4) return;

                if (!globalTitle && lines[0]) globalTitle = lines[0];
                if (lines[2]) uniqueDates.add(lines[2]);

                const cat = lines[1];

                for (let i = 3; i < lines.length; i++) {
                    const rank = i - 3 + 1;
                    const parts = lines[i].split(/\s+/);
                    if (parts.length < 2) continue;

                    const name = parts[0];
                    const sch = parts.slice(1).join(' ');

                    if (!schools[sch]) schools[sch] = { name: sch, students: [], uniqueParts: new Set() };

                    let p = 0;
                    if (rank === 1) p = pts[1];
                    else if (rank === 2) p = pts[2];
                    else if (rank === 3) p = pts[3];
                    else if (rank <= 8) p = pts[4];

                    const catPriority = categoryPriority[cat] || 999;

                    schools[sch].students.push({ name, cat, rank, p, catPriority });
                    schools[sch].uniqueParts.add(name);
                }
            });

            const theadTitle = document.getElementById('theadTitle');
            const theadDate = document.getElementById('theadDate');

            if (globalTitle) {
                theadTitle.innerText = globalTitle + " 學校團體獎";
                theadTitle.style.color = "var(--primary-dark)";
            } else {
                theadTitle.innerText = "學校團體獎公佈表";
                theadTitle.style.color = "#ccc";
            }

            const dateStr = uniqueDates.size > 0 ? Array.from(uniqueDates).join(' / ') : '--';
            theadDate.innerText = "日期：" + dateStr;

            (function setPdfFilename() {
                let fileTitle = (theadTitle.innerText || '學校團體獎').replace(/[\/\\:?*"<>|]/g, '_').trim();
                if (fileTitle.length > 120) fileTitle = fileTitle.slice(0,120);
                document.title = fileTitle;
                window.onbeforeprint = () => { document.title = fileTitle; };
            })();

            const table = document.getElementById('resultTable');

            const rankList = Object.values(schools).map(s => {
                const partCount = s.uniqueParts.size;
                const eligible = partCount >= threshold;
                s.students.sort((a, b) => {
                    if (b.p !== a.p) return b.p - a.p;
                    if (a.rank !== b.rank) return a.rank - b.rank;
                    if (a.catPriority !== b.catPriority) return a.catPriority - b.catPriority;
                    return a.name.localeCompare(b.name);
                });

                let scoreList = (mode === 'all') ? s.students : s.students.slice(0, topX);
                const rankScore = scoreList.reduce((acc, cur) => acc + cur.p, 0);
                let partScore = (mode === 'all' || incPart) ? partCount : 0;
                const totalScore = rankScore + partScore;
                const bestRanks = s.students.map(st => st.rank).sort((a,b)=>a-b);
                return { ...s, eligible, totalScore, rankScore, partScore, partCount, usedStudents: scoreList, bestRanks };
            });

            rankList.sort((a,b) => {
                if (a.eligible !== b.eligible) return a.eligible ? -1 : 1;
                if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
                if (b.rankScore !== a.rankScore) return b.rankScore - a.rankScore;
                if (b.partScore !== a.partScore) return b.partScore - a.partScore;
                const len = Math.max(a.bestRanks.length, b.bestRanks.length);
                for (let k=0;k<len;k++){
                    const ra = a.bestRanks[k] || 999;
                    const rb = b.bestRanks[k] || 999;
                    if (ra !== rb) return ra - rb;
                }
                return 0;
            });

            const existingTbody = table.querySelectorAll('tbody');
            existingTbody.forEach(t => t.remove());

            if (rankList.length === 0) {
                const tb = document.createElement('tbody');
                tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:50px;color:#bbb">請輸入資料</td></tr>';
                table.appendChild(tb);
                return;
            }

            rankList.forEach((sch, idx) => {
                const rankIdx = idx + 1;
                let trClass = 'school-row';
                let rankNum = rankIdx;

                if (!sch.eligible) { trClass += ' ineligible-row'; rankNum = '-'; }
                else if (rankIdx === 1) trClass += ' rank-1';
                else if (rankIdx === 2) trClass += ' rank-2';
                else if (rankIdx === 3) trClass += ' rank-3';

                const tb = document.createElement('tbody');
                tb.className = 'school-block';

                const trTop = document.createElement('tr');
                trTop.className = trClass;
                trTop.innerHTML = `
                    <td class="rank-cell">
                        <div class="color-bar"></div>
                        <div class="rank-content-wrapper">
                            <span class="rank-num">${rankNum}</span>
                        </div>
                    </td>
                    <td>
                        <div class="school-name">${escapeHtml(sch.name)}</div>
                        ${!sch.eligible ? '<span class="ineligible-text">人數不足</span>' : ''}
                    </td>
                    <td><div class="total-score">${sch.totalScore}</div></td>
                    <td><div class="score-val">${sch.rankScore}</div></td>
                    <td><div class="score-val">${sch.partScore} (${sch.partCount}人)</div></td>
                `;

                const trDetail = document.createElement('tr');
                trDetail.className = 'detail-row';
                const stuHtml = sch.students.map(stu => {
                    const isUsed = sch.usedStudents.includes(stu);
                    const cssClass = isUsed ? '' : 'dimmed';
                    let badgeClass = 'badge-normal';
                    if (stu.rank === 1) badgeClass = 'badge-gold';
                    else if (stu.rank === 2) badgeClass = 'badge-silver';
                    else if (stu.rank === 3) badgeClass = 'badge-bronze';
                    const scoreBadge = stu.p > 0 ? `<span class="score-badge ${badgeClass}">+${stu.p}</span>` : '<span style="width:16px;"></span>';
                    return `
                    <div class="student-cell ${cssClass}">
                        <div class="st-name">${escapeHtml(stu.name)}</div>
                        <div class="st-info-row">
                            <div class="st-left-group">
                                <span class="st-cat">${escapeHtml(stu.cat)}</span>
                                <span class="st-rank">#${stu.rank}</span>
                            </div>
                            ${scoreBadge}
                        </div>
                    </div>`;
                }).join('');
                trDetail.innerHTML = `<td colspan="5"><div class="school-body"><div class="student-grid">${stuHtml}</div></div></td>`;

                tb.appendChild(trTop);
                tb.appendChild(trDetail);
                table.appendChild(tb);
            });
        }

        function escapeHtml(text) {
            const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
            return String(text).replace(/[&<>"']/g, function(m){ return map[m]; });
        }

        function preparePrintAvoidSplit(){
            document.querySelectorAll('tbody.page-break-before').forEach(tb => tb.classList.remove('page-break-before'));
            document.querySelectorAll('tbody.too-tall').forEach(tb => tb.classList.remove('too-tall'));

            const sheet = document.getElementById('sheet') || document.body;
            const table = document.getElementById('resultTable');
            const tfoot = table.querySelector('tfoot');
            const sheetRect = sheet.getBoundingClientRect();
            let footerHeight = 0;
            if (tfoot) {
                const tfootRect = tfoot.getBoundingClientRect();
                footerHeight = tfootRect && tfootRect.height ? tfootRect.height : (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-height')) || 0);
            } else {
                footerHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-height')) || 0;
            }

            const pageHeight = Math.max(100, sheetRect.height - footerHeight - 6);
            let currentPageBottom = sheetRect.top + pageHeight;

            const blocks = Array.from(document.querySelectorAll('tbody.school-block'));
            for (let i = 0; i < blocks.length; i++) {
                const tb = blocks[i];
                const rect = tb.getBoundingClientRect();
                if (rect.height > pageHeight - 8) {
                    tb.classList.add('too-tall');
                    tb.classList.add('page-break-before');
                    currentPageBottom = rect.top + pageHeight;
                    continue;
                }

                if (rect.bottom > currentPageBottom - 1) {
                    tb.classList.add('page-break-before');
                    currentPageBottom = rect.top + pageHeight;
                }
            }
        }

        function onBeforePrintHandler() {
            try { recalc(); } catch(e) { /* ignore */ }
            try { preparePrintAvoidSplit(); } catch(e) { console.warn('preparePrintAvoidSplit failed', e); }
        }
        function onAfterPrintHandler() {
            document.querySelectorAll('tbody.page-break-before').forEach(tb => tb.classList.remove('page-break-before'));
            document.querySelectorAll('tbody.too-tall').forEach(tb => tb.classList.remove('too-tall'));
        }

        if (window.matchMedia) {
            const mql = window.matchMedia('print');
            mql.addListener(function(m){
                if (m.matches) onBeforePrintHandler();
                else onAfterPrintHandler();
            });
        }
        if (window.addEventListener) {
            window.addEventListener('beforeprint', onBeforePrintHandler);
            window.addEventListener('afterprint', onAfterPrintHandler);
        } else {
            window.onbeforeprint = onBeforePrintHandler;
            window.onafterprint = onAfterPrintHandler;
        }
    </script>
</body>
</html>
