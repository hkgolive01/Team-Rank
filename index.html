<!DOCTYPE html>
<html lang="zh-HK">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Team Rank (Pro)</title>
    <style>
        :root {
            --primary-dark: #2c3e50;
            --primary-blue: #2980b9;
            --active-scheme: #d35400;
            --gold-bg: #fffbf0;
            --gold-bar: #f1c40f;
            --gold-text: #9a7605;
            --silver-bg: #f8f9fa;
            --silver-bar: #bdc3c7;
            --silver-text: #666;
            --bronze-bg: #fff5eb;
            --bronze-bar: #d35400;
            --bronze-text: #a84300;

            --header-height: 0mm;
            --footer-height: 15mm;
            --a4-side-margin: 4mm;
            --header-row: calc(var(--header-height) / 2);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
            background: #444;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Scheme Selector --- */
        .scheme-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: #eee;
            padding: 5px;
            border-radius: 6px;
        }

        .scheme-btn {
            flex: 1;
            padding: 8px 0;
            border: 1px solid #ccc;
            background: #fff;
            color: #555;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.2s;
        }

        .scheme-btn:hover {
            background: #f0f0f0;
        }

        .scheme-btn.active {
            background: var(--active-scheme);
            color: white;
            border-color: var(--active-scheme);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .left-panel {
            width: 40%;
            background: #fdfdfd;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.08);
            z-index: 20;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 12px;
            border-bottom: none;
            padding-bottom: 6px;
        }

        .config-box {
            background: #fff;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .form-row label {
            width: 90px;
            color: #555;
            font-weight: 600;
        }

        .form-row input[type="number"] {
            width: 60px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-row select {
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f9f9f9;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .score-item label {
            width: auto;
            font-size: 10px;
            color: #777;
            margin-bottom: 2px;
            text-align: center;
        }
        .score-item input {
            width: 100% !important;
            font-size: 12px;
            padding: 2px !important;
        }

        .input-area {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: 220px; /* Slightly taller for weights */
            gap: 10px;
            padding-bottom: 20px;
            align-content: start;
        }

        textarea.data-frame {
            width: 100%;
            height: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            resize: none;
            font-family: monospace;
            background: #fff;
            line-height: 1.4;
        }

        textarea.data-frame:focus {
            border-color: var(--primary-blue);
            background: #fafdff;
            outline: none;
        }

        .input-frame {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .frame-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #f5f5f5;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .frame-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .frame-weight-row {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-top: 2px;
            border-top: 1px dashed #ddd;
        }

        .weight-label {
            font-size: 11px;
            color: #666;
            font-weight: bold;
            margin-right: 4px;
        }

        .weight-btn {
            padding: 2px 8px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 3px;
            color: #555;
        }
        .weight-btn:hover { background: #eee; }
        .weight-btn.active {
            background: #2c3e50;
            color: #fff;
            border-color: #2c3e50;
        }

        .frame-controls .left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .layer-badge {
            display: inline-block;
            background: #fff;
            border: 1px solid #ccc;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 11px;
            color: #333;
            min-width: 35px;
            text-align: center;
            font-weight: bold;
        }

        .group-name {
            color: #c0392b;
            font-weight: 700;
            font-size: 12px;
            margin-left: 2px;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .frame-btn {
            background: #fff;
            border: 1px solid #ccc;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .clear-all-btn {
            background: #fff;
            border: 1px solid #e57373;
            color: #c0392b;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }

        .right-panel {
            width: 60%;
            background: #525659;
            padding: 18px;
            overflow-y: auto;
            display: block;
            text-align: center;
        }

        .preview-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .print-btn {
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .print-btn:active {
            transform: translateY(1px);
        }

        .a4-sheet {
            width: min(210mm, calc(100% - 40px));
            min-height: 297mm;
            background: white;
            margin: 0 auto 30px auto;
            padding: calc(var(--header-height) + 8mm) var(--a4-side-margin) calc(var(--footer-height) + 8mm) var(--a4-side-margin);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            position: relative;
            text-align: left;
            overflow: visible;
        }

        table.result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-bottom: 10px;
            table-layout: fixed;
            word-break: break-word;
            background: white;
        }

        table.result-table thead {
            display: table-header-group;
        }

        table.result-table tfoot {
            display: table-footer-group;
        }

        table.result-table thead tr.title-row th {
            padding-top: calc(var(--header-row) * 0.6);
            padding-bottom: calc(var(--header-row) * 0.4);
            vertical-align: middle;
            text-align: center;
            font-weight: 900;
            font-size: 26px;
            color: var(--primary-dark);
            background: transparent;
        }

        table.result-table thead tr.date-row th {
            padding-top: calc(var(--header-row) * 0.3);
            padding-bottom: calc(var(--header-row) * 0.7);
            vertical-align: middle;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            background: transparent;
        }

        table.result-table thead tr.colhead-row th {
            padding: 6px 4px;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            color: var(--primary-dark);
            border-bottom: none;
            background: #f1ee09e2;
        }

        table.result-table tfoot tr td {
            padding: 6px 8px;
            text-align: center;
            font-size: 11px;
            color: #555;
            border-top: 1px solid #ddd;
            background: #fff;
        }

        table.result-table td {
            padding: 6px 4px;
            border-bottom: none;
            vertical-align: middle;
            color: #333;
            background: #fff;
        }

        tr.detail-row td {
            padding: 0 8px 12px 8px;
            border-bottom: none;
            background-color: inherit;
        }

        .school-body {
            display: block;
            page-break-inside: avoid;
            break-inside: avoid;
            -webkit-column-break-inside: avoid;
            padding-top: 6px;
            padding-bottom: 6px;
        }

        td.rank-cell {
            position: relative;
            padding: 0;
            text-align: center;
            height: 1px;
        }

        .rank-content-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 35px;
        }

        .rank-num {
            font-size: 18px;
            font-weight: bold;
            z-index: 2;
            position: relative;
        }

        .color-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            display: none;
        }

        tr.rank-1, tr.rank-1+.detail-row { background-color: var(--gold-bg); }
        tr.rank-1 .color-bar { display: block; background: var(--gold-bar); }
        tr.rank-1 .rank-num { color: var(--gold-text); font-size: 24px; text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8); }
        tr.rank-1 .school-name { color: var(--gold-text); font-size: 18px; }

        tr.rank-2, tr.rank-2+.detail-row { background-color: var(--silver-bg); }
        tr.rank-2 .color-bar { display: block; background: var(--silver-bar); }
        tr.rank-2 .rank-num { color: var(--silver-text); font-size: 20px; }
        tr.rank-2 .school-name { color: var(--silver-text); font-size: 16px; }

        tr.rank-3, tr.rank-3+.detail-row { background-color: var(--bronze-bg); }
        tr.rank-3 .color-bar { display: block; background: var(--bronze-bar); }
        tr.rank-3 .rank-num { color: var(--bronze-text); font-size: 20px; }
        tr.rank-3 .school-name { color: var(--bronze-text); font-size: 16px; }

        .school-name {
            font-weight: 800;
            font-size: 15px;
            margin-bottom: 2px;
            padding-left: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ineligible-text {
            color: #c0392b;
            font-size: 10px;
            font-weight: bold;
            padding-left: 5px;
        }

        .ineligible-row,
        .ineligible-row+.detail-row {
            opacity: 0.6;
            background: #fafafa;
        }

        .total-score {
            font-size: 16px;
            font-weight: 800;
            color: #333;
            text-align: center;
        }

        .score-val {
            font-size: 12px;
            color: #555;
            text-align: center;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            width: 100%;
            margin-top: 4px;
        }

        .student-cell {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 4px;
            padding: 3px 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 38px;
        }

        .st-name {
            font-size: 11px;
            font-weight: bold;
            color: #222;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .st-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 10px;
            width: 100%;
            line-height: 1.2;
        }

        .st-left-group {
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
        }

        .st-cat {
            color: #666;
            margin-right: 3px;
            max-width: 50px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .st-rank {
            color: #333;
            font-weight: 800;
        }

        .score-badge {
            padding: 0px 3px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 9px;
            min-width: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .badge-gold { background-color: #ffe082; color: #6f4e00; border: 1px solid #ffd54f; }
        .badge-silver { background-color: #e0e0e0; color: #424242; border: 1px solid #bdbdbd; }
        .badge-bronze { background-color: #ffccbc; color: #bf360c; border: 1px solid #ffab91; }
        .badge-normal { background-color: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }

        .dimmed { opacity: 0.5; }
        .dimmed .score-badge { visibility: hidden; }

        @media print {
            @page {
                size: A4;
                margin: 9mm 5mm 5mm 5mm;
            }

            .left-panel,
            .preview-actions,
            .print-btn {
                display: none !important;
            }

            html, body, .right-panel {
                width: 100%;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white;
                overflow: visible !important;
            }

            .a4-sheet {
                width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
                padding-top: 0 !important;
                padding-bottom: 4mm !important;
                padding-left: 4mm !important;
                padding-right: 4mm !important;
                overflow: visible !important;
            }

            tbody.school-block {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            tbody.page-break-before {
                display: table-row-group !important;
                page-break-before: always !important;
            }

            /* --- 新增：列印時隱藏資格不符隊伍邏輯 --- */
            body.print-hide-ineligible .school-block.ineligible-block {
                display: none !important;
            }
        }

        @media (max-width: 900px) {
            .left-panel {
                width: 100%;
                height: 40vh;
                overflow-y: auto;
            }

            .right-panel {
                width: 100%;
                padding: 12px;
            }

            .input-area {
                grid-template-columns: 1fr;
                grid-auto-rows: 220px;
            }
        }
    </style>

<style>
/* Remove spinners in Chrome, Edge, Safari, Opera */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none !important;
  margin: 0 !important;
}

/* Remove spinners in Firefox */
input[type="number"] {
  -moz-appearance: textfield !important;
  appearance: textfield !important;
}

/* Fallback generic rule (higher specificity) */
input[type="number"][class]::-webkit-outer-spin-button,
input[type="number"][class]::-webkit-inner-spin-button {
  -webkit-appearance: none !important;
}
</style>
</head>

<body>
    <div class="left-panel">
        <div class="panel-title">團體獎設定</div>
        
        <div class="scheme-selector">
            <button class="scheme-btn active" onclick="switchScheme(1)" id="btn_scheme_1">方案 1</button>
            <button class="scheme-btn" onclick="switchScheme(2)" id="btn_scheme_2">方案 2</button>
            <button class="scheme-btn" onclick="switchScheme(3)" id="btn_scheme_3">方案 3</button>
            <button class="scheme-btn" onclick="switchScheme(4)" id="btn_scheme_4">方案 4</button>
        </div>

        <div class="config-box">
            <div style="font-weight:bold;margin-bottom:5px;">門檻與名次分數 (第9-16名預設0)</div>
            <div class="form-row">
                <label>最少人數：</label>
                <input type="number" id="cfg_threshold" value="3" onchange="onConfigChange()" />
            </div>
            
            <div class="score-grid" id="scoreInputsContainer">
                </div>
        </div>

        <div class="config-box">
            <div style="font-weight:bold;margin-bottom:5px;">計算模式</div>
            <div class="form-row">
                <select id="cfg_mode" onchange="toggleMode(); onConfigChange();" style="width:100%">
                    <option value="all">全校總分 (參與分 = 總人數)</option>
                    <option value="topX">只算前 X 名 (參與分可選)</option>
                </select>
            </div>
            <div id="topX_opts" style="display:none; padding-left:5px; margin-top:5px; font-size:12px;">
                <div class="form-row">
                    <label style="width:70px">取前幾名</label>
                    <input type="number" id="cfg_topX" value="3" onchange="onConfigChange()" />
                </div>
                <div style="margin-top:4px">
                    <input type="checkbox" id="cfg_inc_part" checked onchange="onConfigChange()" />
                    <label for="cfg_inc_part" style="width:auto; display:inline;">Top X 模式下仍加總參與分</label>
                </div>
            </div>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <div class="panel-title" style="font-size:14px; border:none; margin:0;">貼上成績資料</div>
            <div class="input-actions">
                <button class="clear-all-btn" onclick="clearCurrentScheme()">一鍵清空 (當前方案)</button>
            </div>
        </div>

        <div class="input-area" id="inputContainer"></div>
    </div>

    <div class="right-panel">
        <div class="preview-actions">
            <label style="display:flex; align-items:center; color:#fff; font-size:13px; margin-right:12px; cursor:pointer; user-select:none;">
                <input type="checkbox" id="chk_print_filter" onchange="togglePrintFilter()" style="margin-right:6px; cursor:pointer;">
                列印時隱藏資格不符
            </label>
            <button class="print-btn" onclick="window.print()" title="列印">列印</button>
        </div>

        <div class="a4-sheet" id="sheet">
            <table class="result-table" id="resultTable" aria-label="團體獎排名">
                <colgroup>
                    <col style="width: 5%" />
                    <col style="width: 40%" />
                    <col style="width: 20%" />
                    <col style="width: 15%" />
                    <col style="width: 20%" />
                </colgroup>

                <thead>
                    <tr class="title-row">
                        <th id="theadTitle" colspan="5">學校團體獎公佈表</th>
                    </tr>
                    <tr class="date-row">
                        <th id="theadDate" colspan="5">日期：--</th>
                    </tr>
                    <tr class="colhead-row">
                        <th width="5%">排名</th>
                        <th width="40%">學校</th>
                        <th width="20%">總分</th>
                        <th width="15%">名次分</th>
                        <th width="20%">參與分</th>
                    </tr>
                </thead>

                <tbody id="tableBody">
                    <tr>
                        <td colspan="5" style="text-align:center; padding:50px; color:#bbb;">(等待輸入)</td>
                    </tr>
                </tbody>

                <tfoot>
                    <tr>
                        <td colspan="5" id="tfootRules">規則載入中...</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'teamrank_pro_v2';
        const container = document.getElementById('inputContainer');
        
        // Data Model
        let appData = {
            activeSchemeId: 1,
            schemes: {}
        };

        // Init 16 score inputs
        function initScoreInputs() {
            const grid = document.getElementById('scoreInputsContainer');
            let html = '';
            // Default values for common ranks
            const defaultScores = {1:20, 2:13, 3:8, 4:5, 5:5, 6:5, 7:5, 8:5};
            
            for(let i=1; i<=16; i++) {
                html += `
                <div class="score-item">
                    <label>第 ${i} 名</label>
                    <input type="number" id="p${i}" value="${defaultScores[i]||0}" onchange="onConfigChange()" />
                </div>`;
            }
            grid.innerHTML = html;
        }

        // --- Core Functions ---

        function getEmptyScheme() {
            // Default settings for a new scheme
            return {
                threshold: 3,
                mode: 'all',
                topX: 3,
                incPart: true,
                scores: { // 1-16
                    1:20, 2:13, 3:8, 4:5, 5:5, 6:5, 7:5, 8:5,
                    9:0, 10:0, 11:0, 12:0, 13:0, 14:0, 15:0, 16:0
                },
                frames: [ {text:'', weight: 1} ]
            };
        }

        function loadAllData() {
            initScoreInputs(); // Draw HTML first
            const raw = localStorage.getItem(STORAGE_KEY);
            if(raw) {
                try {
                    appData = JSON.parse(raw);
                    // Legacy migration or empty check
                    if(!appData.schemes) appData = { activeSchemeId:1, schemes:{} };
                } catch(e) {
                    console.error("Load failed", e);
                    appData = { activeSchemeId: 1, schemes: {} };
                }
            } else {
                appData = { activeSchemeId: 1, schemes: {} };
            }

            // Ensure schemes 1-4 exist
            for(let i=1; i<=4; i++) {
                if(!appData.schemes[i]) appData.schemes[i] = getEmptyScheme();
            }

            // Load UI for active scheme
            switchScheme(appData.activeSchemeId || 1, false);
        }

        function saveData() {
            // Save currently active UI state back to object before writing to disk
            updateSchemeDataFromUI(appData.activeSchemeId);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        function updateSchemeDataFromUI(schemeId) {
            const scheme = appData.schemes[schemeId];
            if(!scheme) return;

            scheme.threshold = parseInt(document.getElementById('cfg_threshold').value) || 3;
            scheme.mode = document.getElementById('cfg_mode').value;
            scheme.topX = parseInt(document.getElementById('cfg_topX').value) || 3;
            scheme.incPart = document.getElementById('cfg_inc_part').checked;

            for(let i=1; i<=16; i++) {
                scheme.scores[i] = parseInt(document.getElementById('p'+i).value) || 0;
            }

            // Collect frames
            const frameEls = Array.from(container.querySelectorAll('.input-frame'));
            scheme.frames = frameEls.map(f => {
                return {
                    text: f._textarea.value || '',
                    weight: f._weight || 1
                };
            });
            // Cleanup trailing empty frames
            while(scheme.frames.length > 0 && scheme.frames[scheme.frames.length-1].text.trim() === '') {
                scheme.frames.pop();
            }
            if(scheme.frames.length === 0) scheme.frames.push({text:'', weight:1});
        }

        function switchScheme(id, doSave = true) {
            if(doSave) saveData(); // Save previous state

            appData.activeSchemeId = id;
            const scheme = appData.schemes[id];

            // Update Tabs
            for(let i=1; i<=4; i++) {
                const btn = document.getElementById('btn_scheme_'+i);
                if(i === id) btn.classList.add('active');
                else btn.classList.remove('active');
            }

            // Restore Config UI
            document.getElementById('cfg_threshold').value = scheme.threshold;
            document.getElementById('cfg_mode').value = scheme.mode;
            document.getElementById('cfg_topX').value = scheme.topX;
            document.getElementById('cfg_inc_part').checked = scheme.incPart;
            toggleMode();

            for(let i=1; i<=16; i++) {
                document.getElementById('p'+i).value = scheme.scores[i] !== undefined ? scheme.scores[i] : 0;
            }

            // Restore Frames
            container.innerHTML = '';
            if(scheme.frames && scheme.frames.length > 0) {
                scheme.frames.forEach(f => {
                    addInputFrame(f.text, f.weight, null, true);
                });
            } else {
                addInputFrame('', 1, null, true);
            }
            ensureTrailingEmptyFrame();

            recalc();
        }

        function onConfigChange() {
            saveData();
            recalc();
        }

        function clearCurrentScheme() {
            if(!confirm(`確定要清空「方案 ${appData.activeSchemeId}」的所有內容並還原係數嗎？`)) return;
            
            // Reset frames
            container.innerHTML = '';
            addInputFrame('', 1, null, false); // weight reset to 1
            
            // Note: We deliberately do not reset scores/thresholds, just the data & weights.
            saveData();
            recalc();
        }

        // --- Frame Logic ---

        function makeFrameElement(content = '', weight = 1, layerIndex = null) {
            const wrap = document.createElement('div');
            wrap.className = 'input-frame';
            wrap._weight = weight; // Store weight on DOM

            const controls = document.createElement('div');
            controls.className = 'frame-controls';

            const headRow = document.createElement('div');
            headRow.className = 'frame-header-row';

            const left = document.createElement('div');
            left.className = 'left';

            const layerBadge = document.createElement('div');
            layerBadge.className = 'layer-badge';
            layerBadge.innerText = layerIndex !== null ? `L${layerIndex}` : 'L-';

            const groupName = document.createElement('div');
            groupName.className = 'group-name';
            groupName.innerText = '';

            left.appendChild(layerBadge);
            left.appendChild(groupName);

            const clearBtn = document.createElement('button');
            clearBtn.className = 'frame-btn';
            clearBtn.innerText = '清空';
            clearBtn.onclick = () => {
                wrap.querySelector('textarea').value = '';
                onFrameInput();
            };

            headRow.appendChild(left);
            headRow.appendChild(clearBtn);

            const weightRow = document.createElement('div');
            weightRow.className = 'frame-weight-row';
            
            const wLabel = document.createElement('span');
            wLabel.className = 'weight-label';
            wLabel.innerText = '係數:';
            weightRow.appendChild(wLabel);

            [0.5, 0.75, 1].forEach(val => {
                const btn = document.createElement('div');
                btn.className = 'weight-btn' + (weight === val ? ' active' : '');
                btn.innerText = val === 1 ? '1.0' : val;
                btn.onclick = () => {
                    wrap._weight = val;
                    // update siblings
                    Array.from(weightRow.querySelectorAll('.weight-btn')).forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    saveData();
                    recalc();
                };
                weightRow.appendChild(btn);
            });

            controls.appendChild(headRow);
            controls.appendChild(weightRow);

            const ta = document.createElement('textarea');
            ta.className = 'data-frame';
            ta.value = content || '';
            ta.placeholder = "請貼上成績...\n1. 比賽名稱\n2. 組別\n3. 日期\n4. 姓名 學校";
            ta.addEventListener('input', onFrameInput);

            wrap.appendChild(controls);
            wrap.appendChild(ta);

            wrap._layerBadge = layerBadge;
            wrap._groupName = groupName;
            wrap._textarea = ta;

            return wrap;
        }

        function addInputFrame(content = '', weight = 1, insertAt = null, preventSave = false) {
            const frames = container.querySelectorAll('.input-frame');
            const el = makeFrameElement(content, weight, frames.length + 1);
            if (insertAt !== null && insertAt <= frames.length - 1) {
                container.insertBefore(el, frames[insertAt]);
            } else {
                container.appendChild(el);
            }
            refreshLayerLabels();
            if (!preventSave) {
                ensureTrailingEmptyFrame();
                saveData();
                recalc();
            }
        }

        function ensureTrailingEmptyFrame() {
            const frames = container.querySelectorAll('.input-frame');
            if (frames.length === 0) {
                addInputFrame('', 1, null, true); // Don't trigger infinite loop
                return;
            }
            const last = frames[frames.length - 1];
            const ta = last.querySelector('textarea');
            if (ta.value.trim().length > 0) addInputFrame('', 1, null, true);
        }

        function onFrameInput() {
            refreshLayerLabels();
            ensureTrailingEmptyFrame();
            saveData();
            recalc();
        }

        function refreshLayerLabels() {
            const frames = container.querySelectorAll('.input-frame');
            frames.forEach((f, i) => {
                if (f._layerBadge) f._layerBadge.innerText = `L${i + 1}`;
                try {
                    const txt = f._textarea.value || '';
                    const lines = txt.split('\n').map(l => l.trim()).filter(l => l !== '');
                    const group = lines[1] || '';
                    if (f._groupName) f._groupName.innerText = group;
                } catch (err) {}
            });
        }

        function moveFrame(frameEl, dir) {
            const frames = Array.from(container.querySelectorAll('.input-frame'));
            const idx = frames.indexOf(frameEl);
            if (idx === -1) return;
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= frames.length) return;
            if (dir === -1) container.insertBefore(frameEl, frames[newIdx]);
            else container.insertBefore(frames[newIdx], frameEl);
            refreshLayerLabels();
            saveData();
            recalc();
        }

        function toggleMode() {
            const mode = document.getElementById('cfg_mode').value;
            document.getElementById('topX_opts').style.display = (mode === 'topX') ? 'block' : 'none';
        }

        function togglePrintFilter() {
            const chk = document.getElementById('chk_print_filter');
            if(chk.checked) {
                document.body.classList.add('print-hide-ineligible');
            } else {
                document.body.classList.remove('print-hide-ineligible');
            }
        }

        // --- Calculation ---

        function recalc() {
            const threshold = parseInt(document.getElementById('cfg_threshold').value) || 3;
            const mode = document.getElementById('cfg_mode').value;
            const topX = parseInt(document.getElementById('cfg_topX').value) || 3;
            const incPart = document.getElementById('cfg_inc_part').checked;

            // Load scores 1-16
            const pts = {};
            for(let i=1; i<=16; i++) {
                pts[i] = parseInt(document.getElementById('p'+i).value) || 0;
            }

            // Rules Text
            let rules = `【計分】 冠軍${pts[1]} / 亞軍${pts[2]} / 季軍${pts[3]} (其他名次詳見設定)。 `;
            rules += `需滿 ${threshold} 人。`;
            if (mode === 'all') rules += ` (總分 = 所有名次權重分 + 參與人數)`;
            else rules += ` (總分 = 前${topX}名成績 + ${incPart ? '參與人數' : '0'})`;

            const tfootRuleEl = document.getElementById('tfootRules');
            if (tfootRuleEl) tfootRuleEl.innerText = rules;

            const frames = Array.from(container.querySelectorAll('.input-frame'));
            
            // Priority for sorting students with same points (based on frame order)
            const categoryPriority = {}; 
            frames.forEach((f, idx) => {
                const t = f._textarea.value.trim();
                if (!t) return;
                const lines = t.split('\n').map(l => l.trim()).filter(l => l !== '');
                if (lines.length < 2) return;
                const cat = lines[1];
                if (cat) categoryPriority[cat] = idx + 1; // Lower index = Higher priority
            });

            const schools = {};
            let globalTitle = "";
            let uniqueDates = new Set();

            frames.forEach(f => {
                const txt = f._textarea.value.trim();
                const weight = f._weight || 1; // Get frame coefficient
                
                if (!txt) return;
                const lines = txt.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 4) return;

                if (!globalTitle && lines[0]) globalTitle = lines[0];
                if (lines[2]) uniqueDates.add(lines[2]);

                const cat = lines[1];

                for (let i = 3; i < lines.length; i++) {
                    const rank = i - 3 + 1;
                    const parts = lines[i].split(/\s+/);
                    if (parts.length < 2) continue;

                    const name = parts[0];
                    const sch = parts.slice(1).join(' ');

                    if (!schools[sch]) schools[sch] = { name: sch, students: [], uniqueParts: new Set() };

                    // Calculate Points with Coefficient
                    let rawP = pts[rank] || 0;
                    let finalP = rawP * weight; // Apply coefficient!

                    // Round logic? Usually points can be decimal. 
                    // To keep display clean, we might keep decimals or not.
                    // JS floats are fine.

                    schools[sch].students.push({ 
                        name, 
                        cat, 
                        rank, 
                        p: finalP, 
                        catPriority: categoryPriority[cat] || 999 
                    });
                    schools[sch].uniqueParts.add(name);
                }
            });

            // Update Headers
            const theadTitle = document.getElementById('theadTitle');
            const theadDate = document.getElementById('theadDate');
            if (globalTitle) {
                theadTitle.innerText = globalTitle + " 學校團體獎";
                theadTitle.style.color = "var(--primary-dark)";
            } else {
                theadTitle.innerText = "學校團體獎公佈表";
                theadTitle.style.color = "#ccc";
            }
            const dateStr = uniqueDates.size > 0 ? Array.from(uniqueDates).join(' / ') : '--';
            theadDate.innerText = "日期：" + dateStr;

            // Set Title for Print
            let fileTitle = (theadTitle.innerText || '學校團體獎').replace(/[\/\\:?*"<>|]/g, '_').trim();
            document.title = fileTitle;

            const table = document.getElementById('resultTable');
            const existingTbody = table.querySelectorAll('tbody');
            existingTbody.forEach(t => t.remove());

            // Process Schools
            const rankList = Object.values(schools).map(s => {
                const partCount = s.uniqueParts.size;
                const eligible = partCount >= threshold;
                
                // Sort students: High Points > Low Rank > Cat Priority > Name
                s.students.sort((a, b) => {
                    if (b.p !== a.p) return b.p - a.p;
                    if (a.rank !== b.rank) return a.rank - b.rank;
                    if (a.catPriority !== b.catPriority) return a.catPriority - b.catPriority;
                    return a.name.localeCompare(b.name);
                });

                let scoreList = (mode === 'all') ? s.students : s.students.slice(0, topX);
                const rankScore = scoreList.reduce((acc, cur) => acc + cur.p, 0);
                
                // Participation Score usually is not weighted by coefficient (headcount is headcount)
                // Unless specified otherwise. Standard is +1 per head.
                let partScore = (mode === 'all' || incPart) ? partCount : 0;
                
                const totalScore = rankScore + partScore;
                const bestRanks = s.students.map(st => st.rank).sort((a, b) => a - b);
                
                return { ...s, eligible, totalScore, rankScore, partScore, partCount, usedStudents: scoreList, bestRanks };
            });

            // Sort Schools
            rankList.sort((a, b) => {
                if (a.eligible !== b.eligible) return a.eligible ? -1 : 1;
                if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
                if (b.rankScore !== a.rankScore) return b.rankScore - a.rankScore;
                if (b.partScore !== a.partScore) return b.partScore - a.partScore;
                // Tie breaker: compare best ranks
                const len = Math.max(a.bestRanks.length, b.bestRanks.length);
                for (let k = 0; k < len; k++) {
                    const ra = a.bestRanks[k] || 999;
                    const rb = b.bestRanks[k] || 999;
                    if (ra !== rb) return ra - rb;
                }
                return 0;
            });

            if (rankList.length === 0) {
                const tb = document.createElement('tbody');
                tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:50px;color:#bbb">請輸入資料</td></tr>';
                table.appendChild(tb);
                return;
            }

            rankList.forEach((sch, idx) => {
                const rankIdx = idx + 1;
                let trClass = 'school-row';
                let rankNum = rankIdx;

                if (!sch.eligible) { trClass += ' ineligible-row'; rankNum = '-'; }
                else if (rankIdx === 1) trClass += ' rank-1';
                else if (rankIdx === 2) trClass += ' rank-2';
                else if (rankIdx === 3) trClass += ' rank-3';

                const tb = document.createElement('tbody');
                tb.className = 'school-block';
                
                // 新增：如果資格不符，加上此 class 以便列印控制
                if (!sch.eligible) tb.classList.add('ineligible-block');

                // Format display scores (handle decimals)
                const fmt = (n) => Number.isInteger(n) ? n : n.toFixed(2).replace(/\.00$/, '');

                const trTop = document.createElement('tr');
                trTop.className = trClass;
                trTop.innerHTML = `
                    <td class="rank-cell">
                        <div class="color-bar"></div>
                        <div class="rank-content-wrapper">
                            <span class="rank-num">${rankNum}</span>
                        </div>
                    </td>
                    <td>
                        <div class="school-name">${escapeHtml(sch.name)}</div>
                        ${!sch.eligible ? '<span class="ineligible-text">人數不足</span>' : ''}
                    </td>
                    <td><div class="total-score">${fmt(sch.totalScore)}</div></td>
                    <td><div class="score-val">${fmt(sch.rankScore)}</div></td>
                    <td><div class="score-val">${sch.partScore} (${sch.partCount}人)</div></td>
                `;

                const trDetail = document.createElement('tr');
                trDetail.className = 'detail-row';
                const stuHtml = sch.students.map(stu => {
                    const isUsed = sch.usedStudents.includes(stu);
                    const cssClass = isUsed ? '' : 'dimmed';
                    let badgeClass = 'badge-normal';
                    if (stu.rank === 1) badgeClass = 'badge-gold';
                    else if (stu.rank === 2) badgeClass = 'badge-silver';
                    else if (stu.rank === 3) badgeClass = 'badge-bronze';
                    
                    const scoreBadge = stu.p > 0 ? `<span class="score-badge ${badgeClass}">+${fmt(stu.p)}</span>` : '<span style="width:16px;"></span>';
                    
                    return `
                    <div class="student-cell ${cssClass}">
                        <div class="st-name">${escapeHtml(stu.name)}</div>
                        <div class="st-info-row">
                            <div class="st-left-group">
                                <span class="st-cat">${escapeHtml(stu.cat)}</span>
                                <span class="st-rank">#${stu.rank}</span>
                            </div>
                            ${scoreBadge}
                        </div>
                    </div>`;
                }).join('');
                trDetail.innerHTML = `<td colspan="5"><div class="school-body"><div class="student-grid">${stuHtml}</div></div></td>`;

                tb.appendChild(trTop);
                tb.appendChild(trDetail);
                table.appendChild(tb);
            });
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        // --- Print Logic ---
        function preparePrintAvoidSplit() {
            document.querySelectorAll('tbody.page-break-before').forEach(tb => tb.classList.remove('page-break-before'));
            const sheet = document.getElementById('sheet');
            const pageHeight = 1050; // Approx px height for A4 minus margins
            let currentH = 0;
            
            // Only calc height for visible blocks
            const blocks = Array.from(document.querySelectorAll('tbody.school-block'));
            
            // Check if we are in hidden mode
            const isHiddenMode = document.body.classList.contains('print-hide-ineligible');

            blocks.forEach(tb => {
                // Skip if hidden
                if (isHiddenMode && tb.classList.contains('ineligible-block')) return;

                const h = tb.getBoundingClientRect().height;
                if(currentH + h > pageHeight) {
                    tb.classList.add('page-break-before');
                    currentH = h;
                } else {
                    currentH += h;
                }
            });
        }

        window.onload = loadAllData;
        
        window.onbeforeprint = () => { 
            recalc(); 
            preparePrintAvoidSplit(); 
        };
    </script>
</body>
</html>
